<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motobook</title>
    <!-- Tailwind CSS 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React 및 Babel 로드 -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Supabase JS 라이브러리 로드 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Lucide 아이콘 로드 (브라우저용) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* 가로 스크롤바 숨기기 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        function initializeApp() {
            // --- Supabase 클라이언트 설정 ---
            const supabaseUrl = 'https://blxfcrskmawtymbwtfju.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJseGZjcnNrbWF3dHltYnd0Zmp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxNzM3NTYsImV4cCI6MjA2ODc0OTc1Nn0.-jst4dSXv9MO_0DAOduGnIDiPvb5-ofWNXjmEnHaixc';
            
            const { createClient } = supabase;
            const supabaseClient = createClient(supabaseUrl, supabaseKey);

            // --- Helper Functions ---
            function getYoutubeVideoId(url) {
                if (!url) return null;
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                const match = url.match(regExp);
                return (match && match[2].length === 11) ? match[2] : null;
            }

            const mapProfileToUI = (dbProfile) => ({
                id: dbProfile.id,
                handle: dbProfile.handle,
                name: dbProfile.profile_title,
                icon: dbProfile.profile_image_url,
                catchphrase: dbProfile.profile_slogan,
                intro: dbProfile.profile_marketing_copy,
                createdAt: dbProfile.created_at,
                category: dbProfile.category, 
                links: dbProfile.links ? dbProfile.links.map(mapLinkToUI) : [],
            });

            const mapLinkToUI = (dbLink) => ({
                id: dbLink.id,
                name: dbLink.link_title,
                url: dbLink.link,
                icon: dbLink.link_image_url,
            });

            const mapProfileToDB = (uiProfile) => ({
                handle: uiProfile.handle,
                profile_title: uiProfile.name,
                profile_image_url: uiProfile.icon,
                profile_slogan: uiProfile.catchphrase,
                profile_marketing_copy: uiProfile.intro,
                category: uiProfile.category,
            });

            const mapLinkToDB = (uiLink, profileId) => ({
                profile_id: profileId,
                link_title: uiLink.name,
                link: uiLink.link,
                link_image_url: uiLink.icon,
            });

            // --- 재사용 UI 컴포넌트 ---
            
            const Icon = ({ name, size = 24, className = '' }) => (
                <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>
            );

            const ProfileCard = ({ profile, onNavigate }) => (
              <div onClick={() => onNavigate('profile', profile.handle)} className="flex items-center gap-3 p-3 bg-white rounded-xl shadow-sm hover:shadow-md transition-all cursor-pointer">
                <img src={profile.icon} alt={profile.name} className="w-10 h-10 rounded-2xl flex-shrink-0 object-cover" />
                <div className="flex flex-col flex-grow">
                  <span className="text-sm font-medium text-gray-800">{profile.catchphrase || profile.name}</span>
                  <span className="text-xs text-gray-400">{profile.name}</span>
                </div>
              </div>
            );

            const LinkButton = ({ link }) => (
              <a href={link.url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-4 p-4 bg-white/80 backdrop-blur-sm rounded-xl shadow-md hover:scale-105 transition-all duration-150">
                <img src={link.icon} alt={link.name} className="w-10 h-10 rounded-[10px] flex-shrink-0 object-cover" />
                <span className="font-medium text-gray-900">{link.name}</span>
              </a>
            );

            const YoutubeEmbedCard = ({ link }) => {
                const videoId = getYoutubeVideoId(link.url);
                if (!videoId) return null;
                const thumbnailUrl = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
                return (
                    <a href={link.url} target="_blank" rel="noopener noreferrer" className="block group">
                        <div className="relative overflow-hidden rounded-[20px] shadow-lg">
                            <img src={thumbnailUrl} alt={link.name} className="w-full h-auto object-cover aspect-video group-hover:scale-105 transition-transform duration-300" />
                            <div className="absolute inset-0 bg-black/20 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <Icon name="youtube" size={48} className="text-white" />
                            </div>
                        </div>
                        <p className="mt-3 text-sm font-medium text-gray-700">{link.name}</p>
                    </a>
                );
            };

            const LoadingSpinner = () => (
                <div className="flex justify-center items-center h-screen">
                    <Icon name="loader-2" size={48} className="animate-spin text-indigo-600" />
                </div>
            );

            // --- 사용자 앱 페이지 컴포넌트 ---
            const HomePage = ({ onNavigate, profiles }) => {
              const [activeCategory, setActiveCategory] = React.useState("전체");
              const categories = ["전체", "웹·앱 서비스", "인플루언서", "마켓", "크리에이터", "커뮤니티"];
              const filteredProfiles = activeCategory === "전체" ? profiles
              : profiles.filter(p => p.category === activeCategory);
              return (
                <div className="bg-white min-h-screen font-sans">
                  <nav className="sticky top-0 bg-white/80 backdrop-blur-sm z-10 flex items-center justify-between px-4 h-14 border-b border-gray-100">
                    <h1 className="text-xl font-bold">Motobook</h1>
                    <button className="p-2"><Icon name="menu" size={24} /></button>
                  </nav>
                  <div className="sticky top-14 bg-white/80 backdrop-blur-sm z-10 px-4 py-3 border-b border-gray-100"><div className="flex space-x-2 overflow-x-auto whitespace-nowrap pb-2 -mb-2 no-scrollbar">{categories.map(c => <button key={c} onClick={() => setActiveCategory(c)} className={`px-4 py-2 text-sm font-medium rounded-full transition-colors ${activeCategory === c ? 'bg-black text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>{c}</button>)}</div></div>
                  <main className="p-4 space-y-6"><section><h2 className="text-base font-semibold text-gray-800 pb-2">전체 프로필</h2><div className="space-y-3">{filteredProfiles.map(p => <ProfileCard key={p.id} profile={p} onNavigate={onNavigate} />)}</div></section></main>
                  <footer className="text-center p-4"><button onClick={() => onNavigate('login')} className="text-xs text-gray-400 hover:text-gray-600">관리자 페이지로 이동</button></footer>
                </div>
              );
            };

            const ProfilePage = ({ onNavigate, profileHandle, profiles }) => {
              const profile = profiles.find(p => p.handle === profileHandle);
              if (!profile) return <div className="flex flex-col items-center justify-center min-h-screen"><p className="text-red-500">프로필을 찾을 수 없습니다.</p><button onClick={() => onNavigate('home')} className="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-md">홈으로</button></div>;
              
              const youtubeLinks = profile.links?.filter(link => getYoutubeVideoId(link.url)) || [];
              const regularLinks = profile.links?.filter(link => !getYoutubeVideoId(link.url)) || [];

              return (
                <div className="min-h-screen bg-gradient-to-b from-sky-100 to-emerald-100 font-sans">
                  <nav className="sticky top-0 z-10 flex items-center justify-between px-4 h-14"><button onClick={() => onNavigate('home')} className="p-2"><Icon name="home" size={24} className="text-gray-700" /></button><div className="w-10 h-10" /></nav>
                  <main className="p-4 pb-12"><div className="max-w-md mx-auto space-y-6"><header className="flex flex-col items-center text-center space-y-4"><img src={profile.icon} alt={profile.name} className="w-20 h-20 rounded-[24px] shadow-lg object-cover"/><div><h1 className="text-lg font-semibold text-gray-900">{profile.name}</h1><p className="text-sm text-gray-500 whitespace-pre-line mt-1">{profile.intro}</p></div></header>{youtubeLinks.length > 0 && <section className="space-y-4">{youtubeLinks.map(l => <YoutubeEmbedCard key={l.id} link={l} />)}</section>}{regularLinks.length > 0 && <section className="space-y-3">{regularLinks.map(l => <LinkButton key={l.id} link={l} />)}</section>}</div></main>
                </div>
              );
            };

            // --- 관리자 페이지 컴포넌트 ---
            const StatCard = ({ title, value, icon }) => (
                <div className="bg-white p-6 rounded-lg shadow"><div className="flex items-center"><div className="p-3 rounded-full bg-indigo-100 text-indigo-600 mr-4">{icon}</div><div><p className="text-sm font-medium text-gray-500">{title}</p><p className="text-2xl font-bold text-gray-900">{value.toLocaleString()}</p></div></div></div>
            );

            const ProfileFormModal = ({ profile, onSave, onCancel }) => {
                const [formData, setFormData] = React.useState(
                  profile ? profile : {
                    handle: '', name: '', catchphrase: '', intro: '', icon: '', category: ''
                  }
                );
                const [isGenerating, setIsGenerating] = React.useState({ catchphrase: false, intro: false });
                
                const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
                
                const handleGenerateText = async (fieldName) => {
                    if (!formData.name) {
                        alert('먼저 프로필 제목을 입력해주세요.');
                        return;
                    }
                    setIsGenerating(prev => ({ ...prev, [fieldName]: true }));

                    const promptType = fieldName === 'catchphrase' ? '한 줄 슬로건' : '마케팅 문구 (소개)';
                    const prompt = `'${formData.name}'에 대한 창의적인 ${promptType}를 1~2 문장의 짧은 한국어로 생성해줘.`;

                    try {
                        const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                        const payload = { contents: chatHistory };
                        const apiKey = "";
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                        
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
                        
                        const result = await response.json();
                        
                        if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                            const text = result.candidates[0].content.parts[0].text;
                            setFormData(prev => ({ ...prev, [fieldName]: text.trim() }));
                        } else {
                            throw new Error('Unexpected API response structure');
                        }
                    } catch (error) {
                        console.error('Error generating text with Gemini:', error);
                        alert('AI 문구 생성에 실패했습니다. 잠시 후 다시 시도해주세요.');
                    } finally {
                        setIsGenerating(prev => ({ ...prev, [fieldName]: false }));
                    }
                };

                const handleSubmit = (e) => { e.preventDefault(); onSave(formData); };

                return <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4"><div className="bg-white rounded-lg shadow-xl p-8 w-full max-w-lg"><h2 className="text-xl font-bold mb-6">{profile ? '프로필 수정' : '새 프로필 추가'}</h2><form onSubmit={handleSubmit} className="space-y-4"><input name="name" value={formData.name} onChange={handleChange} placeholder="프로필 제목" className="w-full p-2 border rounded" required /><input name="handle" value={formData.handle} onChange={handleChange} placeholder="고유 핸들 (URL에 사용, 영문/숫자)" className="w-full p-2 border rounded" disabled={!!profile} required /><select name="category" value={formData.category || ""} onChange={handleChange} className="w-full p-2 border rounded" required><option value="">카테고리를 선택하세요</option><option value="웹·앱 서비스">웹·앱 서비스</option><option value="인플루언서">인플루언서</option><option value="마켓">마켓</option><option value="크리에이터">크리에이터</option><option value="커뮤니티">커뮤니티</option></select><div className="relative"><input name="catchphrase" value={formData.catchphrase} onChange={handleChange} placeholder="한 줄 슬로건" className="w-full p-2 border rounded pr-10" /><button type="button" onClick={() => handleGenerateText('catchphrase')} disabled={isGenerating.catchphrase} className="absolute top-1/2 right-2 -translate-y-1/2 text-gray-400 hover:text-indigo-600 disabled:opacity-50">{isGenerating.catchphrase ? <Icon name="loader-2" size={18} className="animate-spin" /> : <Icon name="sparkles" size={18} />}</button></div><div className="relative"><textarea name="intro" value={formData.intro} onChange={handleChange} placeholder="마케팅 문구 (소개)" className="w-full p-2 border rounded pr-10" /><button type="button" onClick={() => handleGenerateText('intro')} disabled={isGenerating.intro} className="absolute top-2 right-2 text-gray-400 hover:text-indigo-600 disabled:opacity-50">{isGenerating.intro ? <Icon name="loader-2" size={18} className="animate-spin" /> : <Icon name="sparkles" size={18} />}</button></div><input name="icon" value={formData.icon} onChange={handleChange} placeholder="프로필 이미지 URL" className="w-full p-2 border rounded" required /><div className="flex justify-end gap-4 pt-4"><button type="button" onClick={onCancel} className="px-4 py-2 bg-gray-200 rounded">취소</button><button type="submit" className="px-4 py-2 bg-indigo-600 text-white rounded">저장</button></div></form></div></div>;
            };

            const LinkFormModal = ({ link, onSave, onCancel }) => {
                const [formData, setFormData] = React.useState(link || { name: '', url: '', icon: '' });
                const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
                const handleSubmit = (e) => { e.preventDefault(); onSave(formData); };
                return <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4"><div className="bg-white rounded-lg shadow-xl p-8 w-full max-w-lg"><h2 className="text-xl font-bold mb-6">{link ? '링크 수정' : '새 링크 추가'}</h2><form onSubmit={handleSubmit} className="space-y-4"><input name="name" value={formData.name} onChange={handleChange} placeholder="링크 제목" className="w-full p-2 border rounded" required /><input name="url" value={formData.url} onChange={handleChange} placeholder="링크 URL (유튜브 링크 가능)" className="w-full p-2 border rounded" type="url" required /><input name="icon" value={formData.icon} onChange={handleChange} placeholder="링크 이미지 URL (일반 링크용)" className="w-full p-2 border rounded" /><div className="flex justify-end gap-4 pt-4"><button type="button" onClick={onCancel} className="px-4 py-2 bg-gray-200 rounded">취소</button><button type="submit" className="px-4 py-2 bg-indigo-600 text-white rounded">저장</button></div></form></div></div>;
            };

            const AdminLoginPage = ({ onLogin }) => ( <div className="flex items-center justify-center min-h-screen bg-gray-100"><div className="w-full max-w-sm p-8 space-y-6 bg-white rounded-lg shadow-md"><h1 className="text-2xl font-bold text-center text-gray-900">Motobook 관리자</h1><form className="space-y-6" onSubmit={(e) => { e.preventDefault(); onLogin(); }}><input type="email" defaultValue="admin@motobook.com" className="mt-1 block w-full px-3 py-2 bg-gray-50 border rounded-md" readOnly/><input type="password" defaultValue="password" className="mt-1 block w-full px-3 py-2 bg-gray-50 border rounded-md" readOnly/><button type="submit" className="w-full flex justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">로그인</button></form></div></div>);

            const AdminDashboard = ({ onNavigate, onLogout, profiles, ...rest }) => {
                const [adminView, setAdminView] = React.useState('dashboard');
                const [selectedProfile, setSelectedProfile] = React.useState(null);
                const [isProfileModalOpen, setProfileModalOpen] = React.useState(false);
                const [editingProfile, setEditingProfile] = React.useState(null);
                const [isLinkModalOpen, setLinkModalOpen] = React.useState(false);
                const [editingLink, setEditingLink] = React.useState(null);
                const { addProfile, updateProfile, deleteProfile, addLink, updateLink, deleteLink } = rest;
                const handleSaveProfile = async (data) => { await (editingProfile ? updateProfile(data) : addProfile(data)); setProfileModalOpen(false); setEditingProfile(null);};
                const handleEditProfile = (p) => { setEditingProfile(p); setProfileModalOpen(true); };
                const handleAddNewProfile = () => { setEditingProfile(null); setProfileModalOpen(true); };
                const handleDeleteProfile = async (id) => { if (window.confirm('정말로 이 프로필을 삭제하시겠습니까?')) await deleteProfile(id); };
                const handleManageLinks = (p) => { setSelectedProfile(p); setAdminView('links'); };
                const handleSaveLink = async (data) => { await (editingLink ? updateLink(selectedProfile.id, { ...data, id: editingLink.id }) : addLink(selectedProfile.id, data)); setLinkModalOpen(false); setEditingLink(null); };
                const handleEditLink = (l) => { setEditingLink(l); setLinkModalOpen(true); };
                const handleAddNewLink = () => { setEditingLink(null); setLinkModalOpen(true); };
                const handleDeleteLink = async (id) => { if (window.confirm('정말로 이 링크를 삭제하시겠습니까?')) await deleteLink(selectedProfile.id, id); };
                const currentSelectedProfile = profiles.find(p => p.id === selectedProfile?.id) || selectedProfile;

                return (
                    <div className="flex h-screen bg-gray-100 font-sans">
                        <aside className="w-64 bg-gray-800 text-white flex flex-col">
                            <div className="h-16 flex items-center justify-center text-xl font-bold border-b border-gray-700">Motobook Admin</div>
                            <nav className="flex-1 px-4 py-6 space-y-2">
                                <button onClick={() => onNavigate('home')} className="w-full flex items-center px-4 py-2 rounded-md text-sm font-medium hover:bg-gray-700"><Icon name="globe" className="mr-3" size={20} /> Motobook 홈으로</button>
                                <button onClick={() => setAdminView('dashboard')} className={`w-full flex items-center px-4 py-2 rounded-md text-sm font-medium ${adminView === 'dashboard' ? 'bg-gray-900' : 'hover:bg-gray-700'}`}><Icon name="layout-dashboard" className="mr-3" size={20} /> 대시보드</button>
                                <button onClick={() => { setAdminView('profiles'); setSelectedProfile(null); }} className={`w-full flex items-center px-4 py-2 rounded-md text-sm font-medium ${adminView === 'profiles' ? 'bg-gray-900' : 'hover:bg-gray-700'}`}><Icon name="users" className="mr-3" size={20} /> 프로필 관리</button>
                            </nav>
                            <div className="p-4 border-t border-gray-700"><button onClick={onLogout} className="w-full flex items-center px-4 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white"><Icon name="log-out" className="mr-3" size={20} /> 로그아웃</button></div>
                        </aside>
                        <main className="flex-1 p-8 bg-gray-100 overflow-y-auto">
                            {adminView === 'dashboard' && <div className="grid grid-cols-1 md:grid-cols-3 gap-6"><StatCard title="총 프로필 수" value={profiles.length} icon={<Icon name="users" size={24}/>} /></div>}
                            {adminView === 'profiles' && (
                                <div>
                                    <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold text-gray-800">프로필 관리</h2><button onClick={handleAddNewProfile} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700"><Icon name="plus-circle" size={18} /> 새 프로필 추가</button></div>
                                    <div className="bg-white p-6 rounded-lg shadow"><div className="overflow-x-auto"><table className="w-full text-sm"><thead><tr className="border-b"><th className="p-2 text-left">프로필 제목(핸들)</th><th className="p-2 text-left">링크 수</th><th className="p-2 text-left">액션</th></tr></thead><tbody>{profiles.map(p => <tr key={p.id} className="border-b"><td className="p-2">{p.name} ({p.handle})</td><td className="p-2">{p.links?.length || 0}</td><td className="p-2 flex gap-2"><button onClick={() => handleManageLinks(p)} className="p-1 text-green-600"><Icon name="link" size={16}/></button><button onClick={() => handleEditProfile(p)} className="p-1 text-blue-500"><Icon name="edit" size={16}/></button><button onClick={() => handleDeleteProfile(p.id)} className="p-1 text-red-500"><Icon name="trash-2" size={16}/></button></td></tr>)}</tbody></table></div></div>
                                </div>
                            )}
                            {adminView === 'links' && currentSelectedProfile && (
                                <div>
                                    <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold text-gray-800">"{currentSelectedProfile.name}" 링크 관리</h2><button onClick={handleAddNewLink} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700"><Icon name="plus-circle" size={18} /> 새 링크 추가</button></div>
                                    <div className="bg-white p-6 rounded-lg shadow"><table className="w-full text-sm"><thead><tr className="border-b"><th className="p-2 text-left">링크명</th><th className="p-2 text-left">URL</th><th className="p-2 text-left">액션</th></tr></thead><tbody>{(currentSelectedProfile.links || []).map(l => <tr key={l.id} className="border-b"><td className="p-2">{l.name}</td><td className="p-2 truncate max-w-xs">{l.url}</td><td className="p-2 flex gap-2"><button onClick={() => handleEditLink(l)} className="p-1 text-blue-500"><Icon name="edit" size={16}/></button><button onClick={() => handleDeleteLink(l.id)} className="p-1 text-red-500"><Icon name="trash-2" size={16}/></button></td></tr>)}</tbody></table></div>
                                </div>
                            )}
                        </main>
                        {isProfileModalOpen && <ProfileFormModal profile={editingProfile} onSave={handleSaveProfile} onCancel={() => setProfileModalOpen(false)} />}
                        {isLinkModalOpen && <LinkFormModal link={editingLink} onSave={handleSaveLink} onCancel={() => setLinkModalOpen(false)} />}
                    </div>
                );
            };

            // --- 메인 앱 컴포넌트 ---
            function App() {
              const [currentPage, setCurrentPage] = React.useState('home');
              const [currentProfileHandle, setCurrentProfileHandle] = React.useState(null);
              const [isAdminAuthenticated, setIsAdminAuthenticated] = React.useState(false);
              const [profiles, setProfiles] = React.useState([]);
              const [loading, setLoading] = React.useState(true);
              const [error, setError] = React.useState(null);

              const fetchProfiles = async () => {
                if (!supabaseClient) return;

                setLoading(true);
                setError(null);

                try {
                  // 1. 프로필 먼저 모두 불러오기
                  const { data: profiles, error: profileError } = await supabaseClient
                    .from("profile")
                    .select("*");

                  if (profileError || !profiles) {
                    throw profileError || new Error("프로필을 불러오지 못했습니다.");
                  }

                  // 2. 각 프로필마다 handle로 링크들 조회
                  const profilesWithLinks = await Promise.all(
                    profiles.map(async (profile) => {
                      const { data: links, error: linkError } = await supabaseClient
                        .from("link")
                        .select("*")
                        .eq("handle", profile.handle);

                      if (linkError) {
                        console.warn(`handle=${profile.handle} 링크 로딩 실패`, linkError);
                      }

                      return {
                        ...profile,
                        links: links || [],
                      };
                    })
                  );

                  // 3. setProfiles 호출
                  setProfiles(profilesWithLinks.map(mapProfileToUI));
                } catch (error) {
                  console.error("Error fetching profiles:", error);
                  setError("데이터를 불러오는 데 실패했습니다.");
                } finally {
                  setLoading(false);
                }
              };

              React.useEffect(() => {
                if (supabaseClient) {
                  fetchProfiles();
                } else {
                  setError('Supabase 클라이언트를 초기화할 수 없습니다. 인터넷 연결을 확인해주세요.');
                  setLoading(false);
                }
              }, []);
              React.useLayoutEffect(() => {
                lucide.createIcons();
              }, [currentPage, profiles]);

              const handleNavigate = (page, handle = null) => { setCurrentPage(page); setCurrentProfileHandle(handle); window.scrollTo(0, 0); };
              const handleLogin = () => { setIsAdminAuthenticated(true); handleNavigate('admin'); };
              const handleLogout = () => { setIsAdminAuthenticated(false); handleNavigate('login'); };
              
              const addProfile = async (p) => {
                const { error } = await supabaseClient.from('profile').insert(mapProfileToDB(p));
                if (error) { console.error('Error adding profile:', error); alert(`프로필 추가 실패: ${error.message}`); } else { await fetchProfiles(); }
              };
              const updateProfile = async (p) => {
                const { error } = await supabaseClient.from('profile').update(mapProfileToDB(p)).eq('id', p.id);
                if (error) { console.error('Error updating profile:', error); alert(`프로필 수정 실패: ${error.message}`); } else { await fetchProfiles(); }
              };
              const deleteProfile = async (id) => {
                const { error } = await supabaseClient.from('profile').delete().eq('id', id);
                if (error) { console.error('Error deleting profile:', error); alert(`프로필 삭제 실패: ${error.message}`); } else { await fetchProfiles(); }
              };
              const addLink = async (profileId, l) => {
                const { error } = await supabaseClient.from('link').insert(mapLinkToDB(l, profileId));
                if (error) { console.error('Error adding link:', error); alert(`링크 추가 실패: ${error.message}`); } else { await fetchProfiles(); }
              };
              const updateLink = async (profileId, l) => {
                const { error } = await supabaseClient.from('link').update(mapLinkToDB(l, profileId)).eq('id', l.id);
                if (error) { console.error('Error updating link:', error); alert(`링크 수정 실패: ${error.message}`); } else { await fetchProfiles(); }
              };
              const deleteLink = async (profileId, linkId) => {
                const { error } = await supabaseClient.from('link').delete().eq('id', linkId);
                if (error) { console.error('Error deleting link:', error); alert(`링크 삭제 실패: ${error.message}`); } else { await fetchProfiles(); }
              };

              const adminProps = { onNavigate: handleNavigate, onLogout: handleLogout, profiles, addProfile, updateProfile, deleteProfile, addLink, updateLink, deleteLink };

              if (loading) return <LoadingSpinner />;
              if (error) return <div className="text-center text-red-500 p-8">{error}</div>;

              if (currentPage === 'login') return <AdminLoginPage onLogin={handleLogin} />;
              if (currentPage === 'admin') return isAdminAuthenticated ? <AdminDashboard {...adminProps} /> : <AdminLoginPage onLogin={handleLogin} />;
              if (currentPage === 'profile') return <ProfilePage onNavigate={handleNavigate} profileHandle={currentProfileHandle} profiles={profiles} />;
              return <HomePage onNavigate={handleNavigate} profiles={profiles} />;
            }

            const container = document.getElementById('root');
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
        }

        function checkLibrariesAndRun() {
            if (window.React && window.ReactDOM && window.supabase && window.lucide) {
                initializeApp();
            } else {
                setTimeout(checkLibrariesAndRun, 100);
            }
        }

        checkLibrariesAndRun();
    </script>
</body>
</html>
